# Google Cloud Build configuration for Android Build Container Image
# Builds, tests, scans, and deploys the Docker image

steps:
  # Step 1: Build Docker image (optimized with optional components)
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--build-arg'
      - 'BASE_IMAGE=${_BASE_IMAGE}'
      - '--build-arg'
      - 'JAVA_VERSION=${_JAVA_VERSION}'
      - '--build-arg'
      - 'JAVA_PACKAGE=${_JAVA_PACKAGE}'
      - '--build-arg'
      - 'NODE_VERSION=${_NODE_VERSION}'
      - '--build-arg'
      - 'ANDROID_BUILD_TOOLS=${_ANDROID_BUILD_TOOLS}'
      - '--build-arg'
      - 'ANDROID_PLATFORM=${_ANDROID_PLATFORM}'
      - '--build-arg'
      - 'ANDROID_CMAKE_VERSION=${_ANDROID_CMAKE_VERSION}'
      - '--build-arg'
      - 'INSTALL_DOCKER_CLI=${_INSTALL_DOCKER_CLI}'
      - '--build-arg'
      - 'INSTALL_GCLOUD_SDK=${_INSTALL_GCLOUD_SDK}'
      - '--build-arg'
      - 'INSTALL_CMAKE=${_INSTALL_CMAKE}'
      - '--build-arg'
      - 'INSTALL_NDK=${_INSTALL_NDK}'
      - '-t'
      - '${_REGISTRY_URL}/${_IMAGE_NAME}:${_IMAGE_TAG}'
      - '-t'
      - '${_REGISTRY_URL}/${_IMAGE_NAME}:latest'
      - '.'

  # Step 2: Security scan with Trivy
  - name: 'aquasec/trivy:latest'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        trivy image --exit-code 1 --severity HIGH,CRITICAL \
          ${_REGISTRY_URL}/${_IMAGE_NAME}:${_IMAGE_TAG} || \
        echo "Security scan completed (non-blocking)"

  # Step 3: Test image (verify tools and helper scripts)
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        docker run --rm ${_REGISTRY_URL}/${_IMAGE_NAME}:${_IMAGE_TAG} \
          bash -c "
            echo 'Testing Java...' && java -version && \
            echo 'Testing Node.js...' && node --version && npm --version && \
            echo 'Testing Android SDK...' && sdkmanager --version && \
            echo 'Testing helper scripts...' && \
            artifact-finder.sh --help > /dev/null 2>&1 && \
            memory-checker.sh > /dev/null && \
            build-validator.sh assembleRelease > /dev/null && \
            echo 'âœ… All tests passed!'
          "
    waitFor: ['-']

  # Step 4: Push to GCP Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGISTRY_URL}/${_IMAGE_NAME}:${_IMAGE_TAG}'
    waitFor: ['-']

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_REGISTRY_URL}/${_IMAGE_NAME}:latest'
    waitFor: ['-']

# Substitutions (all customizable)
substitutions:
  # Base configuration
  _BASE_IMAGE: 'debian:bullseye-slim'  # Changed from ubuntu:22.04 for smaller size
  _JAVA_VERSION: '17'
  _JAVA_PACKAGE: 'openjdk-17-jdk-headless'  # Use headless for smaller size
  _NODE_VERSION: '20'
  _ANDROID_BUILD_TOOLS: '34.0.0'
  _ANDROID_PLATFORM: '34'
  _ANDROID_CMAKE_VERSION: '3.22.1'

  # Optional components (optimize image size by disabling unused tools)
  _INSTALL_DOCKER_CLI: 'false'  # Only needed for Docker-in-Docker
  _INSTALL_GCLOUD_SDK: 'true'   # Enable for GCP Cloud Build (Secret Manager, GCS)
  _INSTALL_CMAKE: 'false'        # Only needed for native C/C++ modules
  _INSTALL_NDK: 'false'          # Only needed for extensive native code

  # Image configuration
  _IMAGE_TAG: 'latest'
  _IMAGE_NAME: 'android-build-image'
  _GCP_PROJECT_ID: ''
  _GCP_REGION: 'europe-west1'
  _GCP_REGISTRY_NAME: 'android-build-images'
  _REGISTRY_URL: '${_GCP_REGION}-docker.pkg.dev/${_GCP_PROJECT_ID}/${_GCP_REGISTRY_NAME}'

# Timeout
timeout: '1800s'

# Options
options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  diskSizeGb: 100

